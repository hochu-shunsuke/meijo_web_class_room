// Menu.gs

/**
 * スプレッドシートを開いたときにカスタムメニューを作成する
 */
function onOpen() {
  SpreadsheetApp.getUi()
      .createMenu('✨ 課題自動取得システム')
      .addItem('1. 認証情報を設定', 'showCredentialDialog') 
      .addItem('2. Tasks連携設定', 'setupTasksList')       
      .addSeparator()
      .addItem('3. 今すぐ実行（テスト）', 'dailySystemRun')
      .addToUi();
}

/**
 * 認証情報入力用のカスタムダイアログを表示する
 * (Properties.gsのsetCredentials関数に依存)
 */
function showCredentialDialog() {
  const html = HtmlService.createHtmlOutput('<div>WebClassのIDとパスワードをScript Propertiesに安全に保存します。<br><input type="text" id="userid" placeholder="ユーザーID"><br><input type="password" id="password" placeholder="パスワード"><br><button onclick="google.script.run.setCredentials(document.getElementById(\'userid\').value, document.getElementById(\'password\').value); window.close();">保存</button></div>')
      .setWidth(300)
      .setHeight(150);
  SpreadsheetApp.getUi().showModalDialog(html, 'WebClass認証情報の設定');
}

/**
 * Google Tasks連携用のタスクリストIDを取得・設定する
 * (Code.gsのgetTaskListId関数に依存)
 */
function setupTasksList() {
    const ui = SpreadsheetApp.getUi();
    // TASK_LIST_NAME は Config.gs の定数
    const taskListName = TASK_LIST_NAME; 
    
    try {
        const taskListId = getTaskListId(taskListName); // Code.gs の関数を呼び出し
        
        // taskListIdをPropertiesServiceに保存
        PropertiesService.getUserProperties().setProperty('taskListId', taskListId);
        
        ui.alert(`✅ Google Tasks連携設定完了。\n利用タスクリスト: 「${taskListName}」に決定しました。\n初回実行時、Googleアカウントのアクセス許可が必要です。`);
        
    } catch (e) {
        ui.alert(`🚨 Tasksリスト設定エラー:\n${e.message}\n\nTasksサービスが有効化されているか、Config.gsのTASK_LIST_NAMEが正しいか確認してください。`);
    }
}