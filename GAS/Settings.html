<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { margin: 10px; }
    </style>
</head>
<body>

    <div class="container-fluid">
        <h4>WebClass 認証情報登録</h4>
        <p class="text-muted">学籍番号とパスワードを入力してください。情報はGoogleの安全な領域に保存されます。</p>
        
        <div id="alert-message" class="alert alert-danger d-none" role="alert"></div>

        <form onsubmit="return handleFormSubmit(this)">
            <div class="mb-3">
                <label for="userid" class="form-label">学籍番号 (User ID)</label>
                <input type="text" class="form-control" id="userid" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">パスワード (Password)</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <button id="save-btn" type="submit" class="btn btn-primary w-100">
                資格情報を登録
            </button>
        </form>
    </div>

    <script>
    // ボタン操作のためのUIエレメントを取得
    const saveButton = document.getElementById('save-btn');
    const alertMessage = document.getElementById('alert-message');

    /**
     * フォーム送信時の処理
     */
    function handleFormSubmit() {
        // フォームデータの取得 ★ここを徹底的にチェック！
        const userid = document.getElementById('userid').value;
        const password = document.getElementById('password').value;
        
        // 入力値が空の場合は、GASサーバーへの送信をせずにHTML側で警告を出す（GAS側のエラーを防ぐ）
        if (!userid || !password) {
            onFailure({message: "学籍番号とパスワードの両方を入力してください。"});
            return false;
        }

        // UIを更新
        saveButton.disabled = true;
        saveButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 保存中...';
        alertMessage.classList.add('d-none'); 

        // GASサーバー側関数 'setCredentials' の呼び出し
        google.script.run
            .withSuccessHandler(onSuccess)
            .withFailureHandler(onFailure)
            .setCredentials(userid, password);
            
        // フォームのデフォルト送信を防ぐ (これが重要)
        return false; 
    }

    /**
     * 登録成功時の処理
     */
    function onSuccess() {
        alertMessage.classList.remove('alert-danger');
        alertMessage.classList.add('alert-success');
        alertMessage.textContent = '✅ 認証情報を正常に保存しました。';
        alertMessage.classList.remove('d-none');
        
        saveButton.disabled = false;
        saveButton.innerHTML = '資格情報を登録';
    }
    
    /**
     * 登録失敗時の処理 (エラーメッセージを表示)
     */
    function onFailure(error) {
        alertMessage.classList.remove('alert-success');
        alertMessage.classList.add('alert-danger');
        // 今回のエラーのように、GAS側から送られたエラーメッセージを表示する
        alertMessage.textContent = '🚨 エラーが発生しました: ' + error.message; 
        alertMessage.classList.remove('d-none');

        saveButton.disabled = false;
        saveButton.innerHTML = '資格情報を登録';
    }
  </script>
</body>
</html>