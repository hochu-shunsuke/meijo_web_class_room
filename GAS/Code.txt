// Code.gs

// ====================================================================
//  GAS èª²é¡Œãƒªãƒã‚¤ãƒ³ãƒ‰ã‚·ã‚¹ãƒ†ãƒ  - æœ€çµ‚å®Œå…¨ç‰ˆ (WebClasså†…éƒ¨å–å¾— & Tasksçµ±åˆ)
//  Config.gs ã®ã™ã¹ã¦ã®å®šæ•°ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
// ====================================================================

// --- ãƒ¡ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œé–¢æ•° ---

/**
 * ã€ãƒ¡ã‚¤ãƒ³é–¢æ•°ã€‘æ¯æ—¥å®šåˆ»ã«å®Ÿè¡Œã™ã‚‹ãƒˆãƒªã‚¬ãƒ¼ã«è¨­å®šã—ã¾ã™ã€‚
 */
function dailySystemRun() {
  Logger.log('--- èª²é¡Œãƒªãƒã‚¤ãƒ³ãƒ‰ã‚·ã‚¹ãƒ†ãƒ  å®Ÿè¡Œé–‹å§‹ ---');
  const ui = SpreadsheetApp.getUi();
  
  try {
    logToSheet('--- èª²é¡Œãƒªãƒã‚¤ãƒ³ãƒ‰ã‚·ã‚¹ãƒ†ãƒ  å®Ÿè¡Œé–‹å§‹ ---');
    
    // 1. WebClassã®æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã‚€ (WebClassèªè¨¼ãŒå¿…è¦)
    fetchWebClassAssignments();
    
    // 2. Classroomã®æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã‚€
    fetchClassroomAssignments(); 
    
    // Tasksé€£æºãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
    if (getTaskListIdProperty()) {
      // 3. Tasksã®å®Œäº†çŠ¶æ…‹ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«åæ˜ ã•ã›ã‚‹ï¼ˆåŒæœŸï¼‰
      syncTaskCompletionStatus(); 
      
      // 4. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®çµ±åˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€æœªç™»éŒ²ãƒ»æœŸé™å†…ã®èª²é¡Œã‚’Tasksã«è¿½åŠ 
      integrateAndRegisterTasks();
    } else {
      logToSheet('âš ï¸ Tasksãƒªã‚¹ãƒˆIDãŒæœªè¨­å®šã®ãŸã‚ã€åŒæœŸãƒ»ç™»éŒ²å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚');
    }
    
    // 5. å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚„å®Œäº†æ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤ï¼ˆæ•´ç†ï¼‰
    cleanupOldAssignments(); 
    
    Logger.log('--- èª²é¡Œãƒªãƒã‚¤ãƒ³ãƒ‰ã‚·ã‚¹ãƒ†ãƒ  å®Ÿè¡Œå®Œäº† ---');
    ui.alert('âœ… å…¨ã¦ã®èª²é¡Œå–å¾—ã¨åŒæœŸå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
    
  } catch(e) {
    Logger.log(`è‡´å‘½çš„ãªã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ${e.toString()}`);
    // æ„å›³çš„ãªè¨ºæ–­ä¸­æ–­ã‚¨ãƒ©ãƒ¼ã®å ´åˆã‚‚ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤º
    if (e.message.includes('WebClassèª²é¡ŒæŠ½å‡ºè¨ºæ–­ã®ãŸã‚') || e.message.includes('WebClassãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—')) {
        ui.alert(`ğŸš¨ è¨ºæ–­ä¸­æ–­: ${e.message}`);
    } else if (e.message.includes('SSOãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ')) {
      // ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ã€ã“ã“ã§ã¯è¿½åŠ ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã•ãªã„
    } else {
      ui.alert(`ğŸš¨ è‡´å‘½çš„ãªã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\nLoggerã‚’ã”ç¢ºèªãã ã•ã„ã€‚\n${e.message}`);
    }
  }
}

// --- WebClass èª²é¡Œå–å¾—é–¢æ•° ---

/**
 * WebClassã‹ã‚‰å…¨ç§‘ç›®ã®èª²é¡Œã‚’å–å¾—ã—ã€ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã‚€
 */
function fetchWebClassAssignments() {
  Logger.log('1. WebClassã®èª²é¡Œå–å¾—å‡¦ç†ã‚’é–‹å§‹...');
  logToSheet('--- WebClass èª²é¡Œå–å¾—å‡¦ç† é–‹å§‹ ---');
  
  const credentials = getCredentials(); 
  if (!credentials) {
    throw new Error('WebClassã®èªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã€Œ1. èªè¨¼æƒ…å ±ã‚’è¨­å®šã€ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ã€‚');
  }
  
  const dashboardUrl = loginWebClass(credentials.userid, credentials.password);
  const dashboardHtml = fetchWithSession(dashboardUrl);
  const courseLinks = parseDashboardForCourseLinks(dashboardHtml); 
  
  if (courseLinks.length === 0) {
    throw new Error('WebClassèª²é¡ŒæŠ½å‡ºè¨ºæ–­ã®ãŸã‚ã€ãƒ¡ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚ç§‘ç›®ãƒªãƒ³ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
  }
  
  Logger.log(`âœ… WebClassã‹ã‚‰${courseLinks.length}ä»¶ã®ç§‘ç›®ãƒªãƒ³ã‚¯ã‚’æ­£å¸¸ã«å–å¾—ã—ã¾ã—ãŸã€‚å€‹åˆ¥ã‚³ãƒ¼ã‚¹ã®èª²é¡Œå–å¾—ã‚’é–‹å§‹ã—ã¾ã™ã€‚`);
  logToSheet(`âœ… ${courseLinks.length}ä»¶ã®ç§‘ç›®ãƒªãƒ³ã‚¯ã‚’æŠ½å‡ºã—ã¾ã—ãŸã€‚`);
  
  const allAssignmentRows = [];
  let totalAssignments = 0;
  
  // 4. å„ã‚³ãƒ¼ã‚¹ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦èª²é¡Œæƒ…å ±ã‚’åé›†
  courseLinks.forEach((course, index) => {
    const courseLogMessage = `[${index + 1}/${courseLinks.length}] ç§‘ç›®: ${course.name} | URL: ${course.url} ã‚’å–å¾—ä¸­...`;
    Logger.log(courseLogMessage);
    logToSheet(courseLogMessage); 
    
    try {
      const courseHtml = fetchWithSession(course.url);
      
      const htmlSize = courseHtml.length;
      const contentSnippet = courseHtml.substring(0, 200).replace(/\s+/g, ' '); 
      
      const successMessage = `   -> HTMLå–å¾—æˆåŠŸã€‚ã‚µã‚¤ã‚º: ${htmlSize} ãƒã‚¤ãƒˆã€‚ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å…ˆé ­: ${contentSnippet}...`;
      Logger.log(successMessage);
      logToSheet(successMessage); 

      // 4-2. èª²é¡Œæƒ…å ±ã‚’è§£æ (Parser.gsã«ä¾å­˜)
      const assignments = parseCourseContents(courseHtml); 
      
      Logger.log(`   -> èª²é¡Œã‚’${assignments.length}ä»¶æ¤œå‡ºã—ã¾ã—ãŸã€‚`);
      logToSheet(`   -> èª²é¡Œã‚’${assignments.length}ä»¶æ¤œå‡ºã—ã¾ã—ãŸã€‚è§£æçµæœã‚’è¡Œã«è¿½åŠ ã—ã¾ã™ã€‚`);
      
      // 4-3. ãƒ‡ãƒ¼ã‚¿ã‚’è¡Œå½¢å¼ã«å¤‰æ›
      assignments.forEach(assignment => {
        const startPeriodStr = assignment.start_period || ''; // æ–°ã—ã„é–‹å§‹æ—¥æ™‚
        const endPeriodStr = assignment.end_period || '';     // æ–°ã—ã„çµ‚äº†æ—¥æ™‚
        
        // ã€è¦æ±‚ã•ã‚ŒãŸãƒ­ã‚®ãƒ³ã‚°ã€‘èª²é¡Œã®è©³ç´°æƒ…å ±ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
        const assignmentLog = `      - èª²é¡Œæ¤œå‡º: T[${assignment.title}] P[${startPeriodStr} - ${endPeriodStr}] C[${assignment.category}] L[${assignment.share_link.substring(0, 50)}...]`;
        Logger.log(assignmentLog);
        logToSheet(assignmentLog);
        
        // â˜…ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’8åˆ—ï¼ˆé–‹å§‹æ—¥æ™‚ã€çµ‚äº†æ—¥æ™‚ã‚’å«ã‚€ï¼‰ã«å¤‰æ›´
        allAssignmentRows.push([
          'WebClass',                   // ã‚½ãƒ¼ã‚¹ (0)
          course.name,                  // æˆæ¥­å (1)
          assignment.title,             // èª²é¡Œã‚¿ã‚¤ãƒˆãƒ« (2)
          startPeriodStr,               // é–‹å§‹æ—¥æ™‚ (3) - NEW
          endPeriodStr,                 // çµ‚äº†æ—¥æ™‚ (4) - NEW
          assignment.share_link,        // èª²é¡Œãƒªãƒ³ã‚¯ (URL) (5)
          '',                           // Tasks ID (6)
          ''                            // ç™»éŒ²æ¸ˆã¿ãƒ•ãƒ©ã‚° (7)
        ]);
        totalAssignments++;
      });
      
    } catch (e) {
      Logger.log(`ğŸš¨ ç§‘ç›®ã€Œ${course.name}ã€ã®èª²é¡Œå–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}ã€‚ã“ã®ç§‘ç›®ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚`);
      logToSheet(`ğŸš¨ ç§‘ç›®ã€Œ${course.name}ã€ã®èª²é¡Œå–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}ã€‚`);
    }
    
    Utilities.sleep(300); 
  });
  
  Logger.log(`ğŸ’¡ å…¨ã¦ã®ã‚³ãƒ¼ã‚¹ã‹ã‚‰åˆè¨ˆ${totalAssignments}ä»¶ã®èª²é¡Œã‚’åé›†ã—ã¾ã—ãŸã€‚`);
  logToSheet(`ğŸ’¡ å…¨ã¦ã®ã‚³ãƒ¼ã‚¹ã‹ã‚‰åˆè¨ˆ${totalAssignments}ä»¶ã®èª²é¡Œã‚’åé›†ã—ã¾ã—ãŸã€‚`);
  
  // 5. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®æ›¸ãè¾¼ã¿
  writeWebClassAssignmentsToSheet(allAssignmentRows);
  
  Logger.log('âœ… WebClassèª²é¡Œå–å¾—å‡¦ç† å®Œäº†ã€‚');
  logToSheet('--- WebClass èª²é¡Œå–å¾—å‡¦ç† å®Œäº† ---');
}

// --- Classroom èª²é¡Œå–å¾—é–¢æ•° (æ–°è¦è¿½åŠ ) ---

/**
 * Classroomã®æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã‚€
 */
function fetchClassroomAssignments() {
  Logger.log('2. Classroomã®èª²é¡Œå–å¾—å‡¦ç†ã‚’é–‹å§‹...');
  logToSheet('--- Classroom èª²é¡Œå–å¾—å‡¦ç† é–‹å§‹ ---');
  
  try {
    const courses = Classroom.Courses.list({
        courseStates: ['ACTIVE'] 
    }).courses;

    if (!courses || courses.length === 0) {
      Logger.log('ğŸš¨ Classroomã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚³ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
      logToSheet('ğŸš¨ Classroomã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚³ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
      return;
    }
    
    Logger.log(`âœ… Classroomã‹ã‚‰${courses.length}ä»¶ã®ã‚³ãƒ¼ã‚¹ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚`);
    
    const allAssignmentRows = [];
    let totalAssignments = 0;
    
    courses.forEach(course => {
      const courseWorks = Classroom.Courses.CourseWork.list(course.id, {
          courseWorkStates: ['PUBLISHED']
      }).courseWork;

      if (!courseWorks) return;
      
      courseWorks.forEach(work => {
        // ç· åˆ‡(dueDate)æƒ…å ±ãŒãªã„èª²é¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
        if (!work.dueDate && !work.dueTime) return; 

        let dueDateString = '';
        if (work.dueDate) {
          const { year, month, day } = work.dueDate;
          const date = new Date(year, month - 1, day); 
          
          if (work.dueTime) {
            const { hours, minutes } = work.dueTime;
            date.setHours(hours || 0, minutes || 0);
          }
          
          dueDateString = Utilities.formatDate(date, Session.getScriptTimeZone(), 'yyyy/MM/dd HH:mm'); // æ›¸å¼ã‚’WebClassã«åˆã‚ã›ã‚‹
        }

        const assignmentLink = work.alternateLink;

        // ã€ãƒ­ã‚®ãƒ³ã‚°ã€‘èª²é¡Œã®è©³ç´°æƒ…å ±ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
        const assignmentLog = `      - Classroomèª²é¡Œæ¤œå‡º: T[${work.title}] D[${dueDateString}] L[${assignmentLink.substring(0, 50)}...]`;
        Logger.log(assignmentLog);
        logToSheet(assignmentLog);
        
        // â˜…ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’8åˆ—ã«å¤‰æ›´ã€‚Classroomã®ç· åˆ‡ã¯ã€Œçµ‚äº†æ—¥æ™‚ã€ã«æ ¼ç´ã—ã€ã€Œé–‹å§‹æ—¥æ™‚ã€ã¯ç©ºæ¬„
        allAssignmentRows.push([
          'Classroom',                  // ã‚½ãƒ¼ã‚¹ (0)
          course.name,                  // æˆæ¥­å (1)
          work.title,                   // èª²é¡Œã‚¿ã‚¤ãƒˆãƒ« (2)
          '',                           // é–‹å§‹æ—¥æ™‚ (3) - ç©ºæ¬„
          dueDateString,                // çµ‚äº†æ—¥æ™‚ (4) - ç· åˆ‡æ—¥æ™‚
          assignmentLink,               // èª²é¡Œãƒªãƒ³ã‚¯ (URL) (5)
          '',                           // Tasks ID (6)
          ''                            // ç™»éŒ²æ¸ˆã¿ãƒ•ãƒ©ã‚° (7)
        ]);
        totalAssignments++;
      });
      Utilities.sleep(100); 
    });
    
    Logger.log(`ğŸ’¡ å…¨ã¦ã®Classroomã‚³ãƒ¼ã‚¹ã‹ã‚‰åˆè¨ˆ${totalAssignments}ä»¶ã®èª²é¡Œã‚’åé›†ã—ã¾ã—ãŸã€‚`);
    logToSheet(`ğŸ’¡ å…¨ã¦ã®Classroomã‚³ãƒ¼ã‚¹ã‹ã‚‰åˆè¨ˆ${totalAssignments}ä»¶ã®èª²é¡Œã‚’åé›†ã—ã¾ã—ãŸã€‚`);
    
    // 3. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®æ›¸ãè¾¼ã¿
    writeClassroomAssignmentsToSheet(allAssignmentRows);
    
  } catch (e) {
    Logger.log(`ğŸš¨ Classroomèª²é¡Œå–å¾—ä¸­ã«è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`);
    logToSheet(`ğŸš¨ Classroomèª²é¡Œå–å¾—ä¸­ã«è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}ã€‚Classroom APIãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
  }
  
  Logger.log('âœ… Classroomèª²é¡Œå–å¾—å‡¦ç† å®Œäº†ã€‚');
  logToSheet('--- Classroom èª²é¡Œå–å¾—å‡¦ç† å®Œäº† ---');
}


// --- ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€é–¢æ•°ç¾¤ ---

// Tasksã®å®Œäº†çŠ¶æ…‹ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«åæ˜ ã•ã›ã‚‹ï¼ˆåŒæœŸï¼‰
function syncTaskCompletionStatus() {
  Logger.log('3. Taskså®Œäº†çŠ¶æ…‹ã®åŒæœŸã¯æœªå®Ÿè£…ã§ã™ã€‚');
  logToSheet('3. Taskså®Œäº†çŠ¶æ…‹ã®åŒæœŸã¯æœªå®Ÿè£…ã§ã™ã€‚');
}

// ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®çµ±åˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€æœªç™»éŒ²ãƒ»æœŸé™å†…ã®èª²é¡Œã‚’Tasksã«è¿½åŠ 
function integrateAndRegisterTasks() {
  Logger.log('4. Tasksã¸ã®èª²é¡Œç™»éŒ²ã¯æœªå®Ÿè£…ã§ã™ã€‚');
  logToSheet('4. Tasksã¸ã®èª²é¡Œç™»éŒ²ã¯æœªå®Ÿè£…ã§ã™ã€‚');
}

// å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚„å®Œäº†æ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤ï¼ˆæ•´ç†ï¼‰
function cleanupOldAssignments() {
  Logger.log('5. å¤ã„ãƒ‡ãƒ¼ã‚¿ã®æ•´ç†ã¯æœªå®Ÿè£…ã§ã™ã€‚');
  logToSheet('5. å¤ã„ãƒ‡ãƒ¼ã‚¿ã®æ•´ç†ã¯æœªå®Ÿè£…ã§ã™ã€‚');
}


// --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤ ---

/**
 * å–å¾—ã—ãŸWebClassã®èª²é¡Œãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã‚€
 */
function writeWebClassAssignmentsToSheet(dataRows) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // SHEET_NAME_WEBCLASS, HEADERã¯Config.gsã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¨ã™ã‚‹
  const sheet = ss.getSheetByName(SHEET_NAME_WEBCLASS) || ss.insertSheet(SHEET_NAME_WEBCLASS);
  
  // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªã‚¢ (ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’é™¤ãå…¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢)
  if (sheet.getLastRow() > 1) {
    sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn()).clearContent();
  }
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼æ›¸ãè¾¼ã¿ (A1ã‹ã‚‰)
  sheet.getRange(1, 1, 1, HEADER.length).setValues([HEADER]).setFontWeight('bold');
  
  // ãƒ‡ãƒ¼ã‚¿æ›¸ãè¾¼ã¿
  if (dataRows.length > 0) {
    sheet.getRange(2, 1, dataRows.length, dataRows[0].length).setValues(dataRows);
  }
  
  SpreadsheetApp.flush(); 
  logToSheet(`âœ… ${dataRows.length}ä»¶ã®WebClassèª²é¡Œã‚’ã‚·ãƒ¼ãƒˆã€Œ${SHEET_NAME_WEBCLASS}ã€ã«æ›¸ãè¾¼ã¿ã¾ã—ãŸã€‚`);
}

/**
 * å–å¾—ã—ãŸClassroomã®èª²é¡Œãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã‚€
 */
function writeClassroomAssignmentsToSheet(dataRows) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // SHEET_NAME_CLASSROOM, HEADERã¯Config.gsã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¨ã™ã‚‹
  const sheet = ss.getSheetByName(SHEET_NAME_CLASSROOM) || ss.insertSheet(SHEET_NAME_CLASSROOM);
  
  // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªã‚¢ (ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’é™¤ãå…¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢)
  if (sheet.getLastRow() > 1) {
    sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn()).clearContent();
  }
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼æ›¸ãè¾¼ã¿ (A1ã‹ã‚‰)
  sheet.getRange(1, 1, 1, HEADER.length).setValues([HEADER]).setFontWeight('bold');
  
  // ãƒ‡ãƒ¼ã‚¿æ›¸ãè¾¼ã¿
  if (dataRows.length > 0) {
    sheet.getRange(2, 1, dataRows.length, dataRows[0].length).setValues(dataRows);
  }
  
  SpreadsheetApp.flush(); 
  logToSheet(`âœ… ${dataRows.length}ä»¶ã®Classroomèª²é¡Œã‚’ã‚·ãƒ¼ãƒˆã€Œ${SHEET_NAME_CLASSROOM}ã€ã«æ›¸ãè¾¼ã¿ã¾ã—ãŸã€‚`);
}

/**
 * æŒ‡å®šã•ã‚ŒãŸåå‰ã®ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã®IDã‚’å–å¾—ã™ã‚‹ã€‚å­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆã™ã‚‹ã€‚
 * @param {string} listName - ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆå (ä¾‹: 'å¤§å­¦èª²é¡Œ')
 * @returns {string} ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆID
 */
function getTaskListId(listName) {
  const lists = Tasks.Tasklists.list().items;
  let taskListId = null;

  // æ—¢å­˜ãƒªã‚¹ãƒˆã®æ¤œç´¢
  for (const list of lists) {
    if (list.title === listName) {
      taskListId = list.id;
      break;
    }
  }

  // å­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦ä½œæˆ
  if (!taskListId) {
    const newTasklist = Tasks.Tasklists.insert({ title: listName });
    taskListId = newTasklist.id;
    Logger.log(`æ–°è¦ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã€Œ${listName}ã€ã‚’ä½œæˆã—ã¾ã—ãŸã€‚ID: ${taskListId}`);
  }

  return taskListId;
}

/**
 * å—ä¿¡ã—ãŸèª²é¡Œãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã‚€ï¼ˆTasks IDã¨ãƒ•ãƒ©ã‚°ã‚’ä¿æŒã—ãªãŒã‚‰ãƒãƒ¼ã‚¸ã™ã‚‹ï¼‰
 * ã€é‡è¦ã€‘8åˆ—æ§‹é€ ï¼ˆTasks ID: 6, ç™»éŒ²æ¸ˆã¿ãƒ•ãƒ©ã‚°: 7, ãƒªãƒ³ã‚¯: 5ï¼‰ã«å¯¾å¿œ
 */
function writeMergedAssignmentsToSheet(sheet, newAssignments) {
    // 1. åˆæœŸè¨­å®šã¨ã—ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ›¸ãè¾¼ã‚€
    if (sheet.getLastRow() === 0) {
        sheet.getRange(1, 1, 1, HEADER.length).setValues([HEADER]).setFontWeight('bold');
    }
  
    // 2. æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€ãƒªãƒ³ã‚¯ã‚’ã‚­ãƒ¼ã¨ã™ã‚‹ãƒãƒƒãƒ—ã‚’ä½œæˆ
    const existingDataMap = new Map();
    // Key: èª²é¡Œãƒªãƒ³ã‚¯(URL), Value: [Tasks ID, ç™»éŒ²æ¸ˆã¿ãƒ•ãƒ©ã‚°]
    const existingData = sheet.getLastRow() > 1 
        ? sheet.getRange(2, 1, sheet.getLastRow() - 1, HEADER.length).getValues()
        : [];
    
    // æ—¢å­˜ã®Tasks IDã¨ç™»éŒ²æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ä¿æŒ
    existingData.forEach(row => {
        const link = row[5]; // èª²é¡Œãƒªãƒ³ã‚¯ (URL) (Index 5)
        const tasksId = row[6]; // Tasks ID (Index 6)
        const registeredFlag = row[7]; // ç™»éŒ²æ¸ˆã¿ãƒ•ãƒ©ã‚° (Index 7)
        if (link) {
            existingDataMap.set(link, [tasksId, registeredFlag]);
        }
    });
    
    const mergedAssignments = [];
  
    // 3. æ–°ã—ã„èª²é¡Œãƒ‡ãƒ¼ã‚¿ã«æ—¢å­˜ã®Tasksæƒ…å ±ã‚’ãƒãƒ¼ã‚¸
    newAssignments.forEach(newRow => {
        const link = newRow[5]; // èª²é¡Œãƒªãƒ³ã‚¯ (URL) (Index 5)
        if (existingDataMap.has(link)) {
            const [tasksId, registeredFlag] = existingDataMap.get(link);
            newRow[6] = tasksId; // Tasks ID (Index 6)
            newRow[7] = registeredFlag; // ç™»éŒ²æ¸ˆã¿ãƒ•ãƒ©ã‚° (Index 7)
        } else {
            newRow[6] = '';
            newRow[7] = '';
        }
        mergedAssignments.push(newRow);
    });

    // 4. æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿è¡Œã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¯æ®‹ã™ï¼‰
    sheet.getRange(2, 1, sheet.getMaxRows(), HEADER.length).clearContent();
    
    // 5. çµåˆã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’2è¡Œç›®ã‹ã‚‰æ›¸ãè¾¼ã‚€
    if (mergedAssignments.length > 0) {
        sheet.getRange(2, 1, mergedAssignments.length, mergedAssignments[0].length).setValues(mergedAssignments);
    }
    
    // 6. æœ€çµ‚æ›´æ–°æ—¥æ™‚ã‚’A1ã«è¨˜è¼‰
    sheet.getRange('A1').setValue('æœ€çµ‚æ›´æ–°: ' + new Date().toLocaleString());
    SpreadsheetApp.flush();
}

/**
 * Tasksã®å®Œäº†çŠ¶æ…‹ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«åæ˜ ã•ã›ã‚‹ï¼ˆåŒæœŸï¼‰
 * ã€é‡è¦ã€‘8åˆ—æ§‹é€ ï¼ˆTasks ID: 6, ç™»éŒ²æ¸ˆã¿ãƒ•ãƒ©ã‚°: 7ï¼‰ã«å¯¾å¿œ
 */
function syncTaskCompletionStatus() {
  logToSheet('--- Taskså®Œäº†çŠ¶æ…‹ã®åŒæœŸå‡¦ç† é–‹å§‹ ---');
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheetNames = [SHEET_NAME_WEBCLASS, SHEET_NAME_CLASSROOM]; 
  const taskListId = getTaskListIdProperty(); // Properties.gs ã®é–¢æ•°
  
  if (!taskListId) return;

  sheetNames.forEach(sheetName => {
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet || sheet.getLastRow() <= 1) return;
    
    const range = sheet.getRange(2, 1, sheet.getLastRow() - 1, HEADER.length);
    const data = range.getValues();
    let updated = false;

    data.forEach((row, index) => {
      const tasksId = row[6]; // Tasks ID (Index 6)
      const registeredFlag = row[7]; // ç™»éŒ²æ¸ˆã¿ãƒ•ãƒ©ã‚° (Index 7)
      
      // Tasks IDãŒã‚ã‚Šã€ã‹ã¤ã¾ã å®Œäº†/å‰Šé™¤æ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯ã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿ãƒã‚§ãƒƒã‚¯
      if (tasksId && registeredFlag !== 'COMPLETED' && registeredFlag !== 'DELETED') {
        try {
          const task = Tasks.Tasks.get(taskListId, tasksId);
          
          if (task.status === 'completed') {
            data[index][7] = 'COMPLETED'; // å®Œäº†
            updated = true;
            logToSheet(`âœ… Taskså®Œäº†ã‚’ã‚·ãƒ¼ãƒˆã«åŒæœŸ: ${row[2]} (${sheetName})`);
          }
        } catch (e) {
          // Taskså´ã§ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒTaskså´ã§å‰Šé™¤ã—ãŸå ´åˆãªã©ï¼‰
          if (e.toString().includes('notFound')) {
            data[index][7] = 'DELETED'; // å‰Šé™¤æ¸ˆã¿
            updated = true;
            logToSheet(`âš ï¸ Tasksã§ã‚¿ã‚¹ã‚¯ãŒå‰Šé™¤ã•ã‚Œã¦ã„ãŸãŸã‚DELETEDã«ãƒãƒ¼ã‚¯: ${row[2]} (${sheetName})`);
          } else {
            Logger.log(`ğŸš¨ TasksåŒæœŸã‚¨ãƒ©ãƒ¼ (${tasksId}): ${e.message}`);
          }
        }
      }
    });

    if (updated) {
      range.setValues(data);
      SpreadsheetApp.flush();
      Logger.log(`${sheetName} ã®Taskså®Œäº†çŠ¶æ…‹ã‚’åŒæœŸã—ã¾ã—ãŸã€‚`);
    }
  });
  logToSheet('--- Taskså®Œäº†çŠ¶æ…‹ã®åŒæœŸå‡¦ç† å®Œäº† ---');
}


/**
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®çµ±åˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€æœªç™»éŒ²ãƒ»æœŸé™å†…ã®èª²é¡Œã‚’Tasksã«è¿½åŠ 
 * ã€é‡è¦ã€‘8åˆ—æ§‹é€ ï¼ˆTasks ID: 6, ç™»éŒ²æ¸ˆã¿ãƒ•ãƒ©ã‚°: 7ï¼‰ã«å¯¾å¿œ
 */
function integrateAndRegisterTasks() {
  const taskListId = getTaskListIdProperty(); 
  if (!taskListId) return;

  logToSheet('--- Tasksèª²é¡Œç™»éŒ²å‡¦ç† é–‹å§‹ ---');

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheetNames = [SHEET_NAME_WEBCLASS, SHEET_NAME_CLASSROOM]; 

  sheetNames.forEach(sheetName => {
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet || sheet.getLastRow() <= 1) return;

    const range = sheet.getRange(2, 1, sheet.getLastRow() - 1, HEADER.length);
    const data = range.getValues();
    let updated = false;

    data.forEach((row, index) => {
      const [source, courseName, title, startDate, dueDate, link, tasksId, registeredFlag] = row;
      
      // æœªç™»éŒ²ã‹ã¤æœªå®Œäº†/å‰Šé™¤æ¸ˆã¿ãƒ•ãƒ©ã‚°ã®èª²é¡Œã‚’å¯¾è±¡ã¨ã™ã‚‹
      if (!tasksId && registeredFlag !== 'COMPLETED' && registeredFlag !== 'DELETED' && registeredFlag !== 'EXPIRED') {
        
        let dueDateTime = null;
        
        // â˜…ä¿®æ­£ç‚¹1: dueDateãŒæœ‰åŠ¹ãªæ–‡å­—åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
        if (typeof dueDate === 'string' && dueDate.trim().length > 0) {
            
            // æœŸé™ãŒéå»ã®ã‚‚ã®ã‹ãƒã‚§ãƒƒã‚¯ (dueDateãŒç©ºæ¬„ã§ãªã„ã“ã¨)
            // 'yyyy/MM/dd HH:mm' å½¢å¼ã‚’ Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
            const dateStr = dueDate.replace(/\//g, '-');
            dueDateTime = new Date(dateStr);
            
            if (dueDateTime.toString() === 'Invalid Date') {
                Logger.log(`ğŸš¨ ç„¡åŠ¹ãªæ—¥ä»˜å½¢å¼ã‚’æ¤œå‡º (${sheetName}, ${title}): ${dueDate}`);
                return; // ç„¡åŠ¹ãªæ—¥ä»˜ã¯ã‚¹ã‚­ãƒƒãƒ—
            }
            
            if (dueDateTime.getTime() < new Date().getTime()) {
                // æ—¢ã«æœŸé™åˆ‡ã‚Œã®å ´åˆã¯ç™»éŒ²ã—ãªã„
                row[7] = 'EXPIRED'; // æœŸé™åˆ‡ã‚Œãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
                updated = true;
                return;
            }
        }

        try {
          // Tasks APIã«ç™»éŒ²ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
          const task = Tasks.newTask();
          
          // èª²é¡Œã‚¿ã‚¤ãƒˆãƒ«ã¨æˆæ¥­å
          task.title = `[${courseName}] ${title}`;
          
          // ç· åˆ‡æ—¥æ™‚ (dueDateTimeãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿è¨­å®š)
          if (dueDateTime) {
            // UTCã«å¤‰æ›ã—ã¦ã€Tasksã®dueã«è¨­å®š
            task.due = dueDateTime.toISOString().split('.')[0] + '.000Z';
          }
          
          // ãƒªãƒ³ã‚¯ (Notesã¨ã—ã¦è¿½åŠ )
          // dueDateã¯æ–‡å­—åˆ—ã¨ã—ã¦ç›´æ¥ä½¿ç”¨
          task.notes = `èª²é¡Œãƒªãƒ³ã‚¯:\n${link}\n\nã‚½ãƒ¼ã‚¹: ${source}${startDate ? `\né–‹å§‹æ—¥æ™‚: ${startDate}` : ''}${dueDate ? `\nçµ‚äº†æ—¥æ™‚/ç· åˆ‡: ${dueDate}` : ''}`;

          // Tasks APIã§ã‚¿ã‚¹ã‚¯ã‚’æŒ¿å…¥ (ç™»éŒ²)
          const insertedTask = Tasks.Tasks.insert(task, taskListId);
          
          // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è©²å½“è¡Œã‚’æ›´æ–°
          data[index][6] = insertedTask.id; // Tasks IDã‚’Index 6ã«ä¿å­˜
          data[index][7] = 'REGISTERED';   // ç™»éŒ²æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’Index 7ã«è¨­å®š
          updated = true;
          logToSheet(`âœ… èª²é¡Œã‚’Tasksã«ç™»éŒ²: ${task.title}`);
          
        } catch (e) {
          Logger.log(`ğŸš¨ Tasksç™»éŒ²å¤±æ•— (${sheetName}, ${title}): ${e.message}`);
          logToSheet(`ğŸš¨ Tasksç™»éŒ²å¤±æ•— (${title}): ${e.message}`);
        }
      }
    });

    if (updated) {
      range.setValues(data);
      SpreadsheetApp.flush();
    }
  });
  logToSheet('--- Tasksèª²é¡Œç™»éŒ²å‡¦ç† å®Œäº† ---');
}


// --------------------------------------------------------------------
// --- 5. å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚„å®Œäº†æ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤ï¼ˆæ•´ç†ï¼‰ ---
// --------------------------------------------------------------------

/**
 * å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚„å®Œäº†æ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤ï¼ˆæ•´ç†ï¼‰
 * ã€é‡è¦ã€‘8åˆ—æ§‹é€ ï¼ˆTasks ID: 6, ç™»éŒ²æ¸ˆã¿ãƒ•ãƒ©ã‚°: 7ï¼‰ã«å¯¾å¿œ
 */
function cleanupOldAssignments() {
    logToSheet('--- å¤ã„ãƒ‡ãƒ¼ã‚¿æ•´ç†å‡¦ç† é–‹å§‹ ---');
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetNames = [SHEET_NAME_WEBCLASS, SHEET_NAME_CLASSROOM]; 
    const today = new Date();

    sheetNames.forEach(sheetName => {
        const sheet = ss.getSheetByName(sheetName);
        if (!sheet || sheet.getLastRow() <= 1) return;

        const dataRange = sheet.getRange(2, 1, sheet.getLastRow() - 1, HEADER.length);
        const data = dataRange.getValues();
        
        // å‰Šé™¤å¯¾è±¡è¡Œã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ ¼ç´
        const rowsToDelete = []; 

        data.forEach((row, index) => {
            const [source, courseName, title, startDate, dueDate, link, tasksId, registeredFlag] = row;
            
            // 1. Tasksé€£æºæ¸ˆã¿ã§å®Œäº†/å‰Šé™¤æ¸ˆã¿/æœŸé™åˆ‡ã‚Œã®èª²é¡Œ
            if (['COMPLETED', 'DELETED', 'EXPIRED'].includes(registeredFlag)) {
                rowsToDelete.push(index + 2); // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¡Œç•ªå·ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹+2 
                return;
            }
            
            // 2. Tasksæœªé€£æºã®èª²é¡Œã§ã€ç· åˆ‡ï¼ˆçµ‚äº†æ—¥æ™‚ï¼‰ã‹ã‚‰ä¸€å®šæœŸé–“ï¼ˆä¾‹: 7æ—¥ï¼‰ãŒçµŒéã—ãŸã‚‚ã®
            if (!tasksId && dueDate) {
                const dueDateTime = new Date(dueDate.replace(/\//g, '-'));
                // ç· åˆ‡ã‹ã‚‰7æ—¥çµŒéã—ã¦ã„ã‚‹ã‹
                const daysAfterDue = (today.getTime() - dueDateTime.getTime()) / (1000 * 60 * 60 * 24);
                
                if (daysAfterDue > 7) {
                    rowsToDelete.push(index + 2);
                }
            }
        });

        // è¡Œç•ªå·ãŒå¤§ãã„é †ã«å‰Šé™¤ã™ã‚‹ã“ã¨ã§ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãšã‚Œã‚’é˜²ã
        rowsToDelete.sort((a, b) => b - a);

        rowsToDelete.forEach(rowNum => {
            sheet.deleteRow(rowNum);
        });
        
        if (rowsToDelete.length > 0) {
            Logger.log(`${sheetName} ã‹ã‚‰ ${rowsToDelete.length} ä»¶ã®å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
            logToSheet(`âœ… ${sheetName} ã‹ã‚‰ ${rowsToDelete.length} ä»¶ã®å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
        }
    });
    logToSheet('--- å¤ã„ãƒ‡ãƒ¼ã‚¿æ•´ç†å‡¦ç† å®Œäº† ---');
}


/**
 * ãƒ­ã‚°ã‚·ãƒ¼ãƒˆã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨˜éŒ²ã™ã‚‹
 */
function logToSheet(message) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let logSheet = ss.getSheetByName('ãƒ­ã‚°');
  if (!logSheet) {
    logSheet = ss.insertSheet('ãƒ­ã‚°');
    logSheet.appendRow(['ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—', 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸']);
  }
  
  logSheet.appendRow([new Date(), message]);
}